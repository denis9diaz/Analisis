---
import EstadisticasUsuario from "../components/EstadisticasUsuario";
---

<script is:inline>
  const token = localStorage.getItem("access_token");
  if (!token) {
    window.location.href = "/inicio-sesion";
  }
</script>

<div class="min-h-screen bg-gray-200 text-black py-20 px-4">
  <div class="max-w-2xl mx-auto space-y-10">
    <!-- 🧑 Perfil -->
    <section
      class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm space-y-4"
    >
      <h2 class="text-lg font-medium text-gray-800">Perfil</h2>

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1"
          >Username</label
        >
        <div class="flex items-center gap-2">
          <input
            id="username-input"
            class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm"
            disabled
          />
          <button
            id="edit-username"
            class="text-gray-500 hover:text-blue-600 text-sm">✏️</button
          >
          <button
            id="save-username"
            class="bg-blue-600 text-white rounded px-3 py-1.5 text-sm hidden"
          >
            Guardar
          </button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">Email</label
        >
        <input
          id="email-input"
          class="w-full border border-gray-200 rounded px-3 py-1.5 text-sm bg-gray-100"
          disabled
        />
      </div>
    </section>

    <!-- 💳 Suscripción -->
    <section
      id="suscripcion-section"
      class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm space-y-4"
      style="display: none;"
    >
      <h2 class="text-lg font-medium text-gray-800">Suscripción</h2>
      <p id="suscripcion-mensaje" class="text-sm text-gray-700">
        Plan: <strong id="suscripcion-plan" class="text-green-700"></strong><br
        />
        Válida hasta: <span id="suscripcion-fecha" class="font-medium"></span>
      </p>
    </section>

    <!-- 📊 Resumen -->
    <section
      class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm space-y-4"
    >
      <h2 class="text-lg font-medium text-gray-800">Resumen</h2>

      <div class="grid grid-cols-2 gap-4">
        <div class="bg-gray-100 rounded p-4 text-center">
          <p class="text-sm text-gray-600">Métodos creados</p>
          <p id="metodos-count" class="text-xl font-semibold">0</p>
        </div>
        <div class="bg-gray-100 rounded p-4 text-center">
          <p class="text-sm text-gray-600">Partidos registrados</p>
          <p id="partidos-count" class="text-xl font-semibold">0</p>
        </div>
      </div>
    </section>

    <!-- 📈 Gráficos dinámicos -->
    <section class="space-y-6">
      <EstadisticasUsuario client:load />
    </section>

    <!-- ⚙️ Opciones avanzadas -->
    <section class="text-center text-sm text-gray-500 space-y-2 mt-10">
      <a href="cambiar-contraseña" class="hover:text-blue-600 underline"
        >Cambiar contraseña</a
      ><br />
      <a href="/eliminar" class="hover:text-red-600 underline"
        >Eliminar cuenta</a
      >
    </section>
  </div>

  <!-- 🔔 Toast Notification -->
  <div
    id="toast"
    class="fixed bottom-6 right-6 text-white px-4 py-2 rounded shadow-md text-sm opacity-0 transition-opacity duration-300 pointer-events-none z-50"
  >
    Username actualizado
  </div>
</div>

<!-- Modal de confirmación para eliminar cuenta -->
<div
  id="delete-modal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
>
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">¿Estás seguro?</h2>
    <p class="text-sm text-gray-600 mb-4">
      Esta acción eliminará tu cuenta permanentemente y no podrás recuperarla.
    </p>
    <div class="flex justify-end gap-4">
      <button
        id="cancel-delete"
        class="text-sm text-gray-600 hover:text-blue-600">Volver atrás</button
      >
      <button
        id="confirm-delete"
        class="text-sm bg-red-800 text-white px-4 py-1.5 rounded hover:bg-red-900"
      >
        Eliminar
      </button>
    </div>
  </div>
</div>

<script type="module">
  const access = localStorage.getItem("access_token");

  const authFetch = (url, options = {}) => {
    return fetch(`http://localhost:8000${url}`, {
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${access}`,
      },
      ...options,
    });
  };

  const usernameInput = document.getElementById("username-input");
  const emailInput = document.getElementById("email-input");
  const editBtn = document.getElementById("edit-username");
  const saveBtn = document.getElementById("save-username");
  const statsMetodos = document.getElementById("metodos-count");
  const statsPartidos = document.getElementById("partidos-count");

  async function loadUser() {
    const res = await authFetch("/api/auth/me/");
    if (res.ok) {
      const data = await res.json();
      usernameInput.value = data.username;
      emailInput.value = data.email;
    } else {
      showToast("No se pudo cargar tu perfil", "error");
    }

    const statsRes = await authFetch("/api/general/stats/");
    if (statsRes.ok) {
      const stats = await statsRes.json();
      statsMetodos.textContent = stats.metodos;
      statsPartidos.textContent = stats.partidos;
    }
  }

  editBtn.addEventListener("click", () => {
    usernameInput.disabled = false;
    saveBtn.classList.remove("hidden");
  });

  saveBtn.addEventListener("click", async () => {
    const newUsername = usernameInput.value.trim();
    const currentUsername = localStorage.getItem("username");

    if (!newUsername) {
      showToast("El username no puede estar vacío", "warning");
      return;
    }

    if (newUsername === currentUsername) {
      showToast("El username es el mismo que el actual", "info");
      return;
    }

    const res = await authFetch("/api/auth/update-username/", {
      method: "PATCH",
      body: JSON.stringify({ username: newUsername }),
    });

    const data = await res.json();

    if (res.ok) {
      localStorage.setItem("username", newUsername);
      usernameInput.disabled = true;
      saveBtn.classList.add("hidden");
      showToast("Username actualizado", "success");

      // 🔄 Refrescar header con nuevo username
      if (typeof window.checkToken === "function") {
        window.checkToken();
      }
    } else if (data?.error) {
      showToast(data.error, "error");
    } else {
      showToast("Error al actualizar el username", "error");
    }
  });

  function showToast(message = "Acción completada", type = "success") {
    const toast = document.getElementById("toast");
    if (!toast) return;

    const colorClasses = {
      success: "bg-green-600",
      error: "bg-red-600",
      info: "bg-blue-600",
      warning: "bg-yellow-500 text-black",
    };

    toast.className =
      "fixed bottom-6 right-6 text-white px-4 py-2 rounded shadow-md text-sm opacity-0 transition-opacity duration-300 pointer-events-none z-50";

    const classListToAdd = (colorClasses[type] || colorClasses.success).split(
      " "
    );
    toast.classList.add(...classListToAdd);
    toast.textContent = message;

    toast.classList.remove("opacity-0");
    toast.classList.add("opacity-100");

    setTimeout(() => {
      toast.classList.add("opacity-0");
      toast.classList.remove("opacity-100");
    }, 2500);
  }

  loadUser();
  loadSuscripcion();

  async function loadSuscripcion() {
    const res = await authFetch("/api/general/suscripcion/");
    const section = document.getElementById("suscripcion-section");
    const mensaje = document.getElementById("suscripcion-mensaje");

    section.style.display = "block";

    if (!res.ok) {
      mensaje.textContent = "No se pudo cargar tu suscripción.";
      return;
    }

    const data = await res.json();
    if (!data || !data.activa) {
      mensaje.textContent = "No tienes ninguna suscripción activa.";
      return;
    }

    mensaje.innerHTML = `Plan: <strong class="text-green-700">${data.plan}</strong><br/>Válida hasta: <span class="font-medium">${new Date(data.fecha_fin).toLocaleDateString()}</span>`;
  }

  // Eliminar cuenta con confirmación
  const deleteLink = document.querySelector('a[href="/eliminar"]');
  const modal = document.getElementById("delete-modal");
  const cancelBtn = document.getElementById("cancel-delete");
  const confirmBtn = document.getElementById("confirm-delete");

  deleteLink.addEventListener("click", (e) => {
    e.preventDefault();
    modal.classList.remove("hidden");
  });

  cancelBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  confirmBtn.addEventListener("click", async () => {
    const res = await authFetch("/api/auth/delete-user/", {
      method: "DELETE",
    });

    if (res.ok) {
      localStorage.clear();
      showToast("Cuenta eliminada", "success");
      setTimeout(() => {
        window.location.href = "/";
      }, 1500);
    } else {
      showToast("Error al eliminar cuenta", "error");
      modal.classList.add("hidden");
    }
  });
</script>
