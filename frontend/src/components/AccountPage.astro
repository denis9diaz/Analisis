---
import EstadisticasUsuario from "../components/EstadisticasUsuario";
---

<script is:inline>
  const token = localStorage.getItem("access_token");
  if (!token) {
    window.location.href = "/inicio-sesion";
  }
</script>

<div class="min-h-screen bg-gray-200 text-black py-20 px-4">
  <div class="max-w-2xl mx-auto space-y-10">
    <!--  Perfil -->
    <section
      class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm space-y-4"
    >
      <h2 class="text-lg font-medium text-gray-800">Perfil</h2>

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1"
          >Username</label
        >
        <div class="flex items-center gap-2">
          <input
            id="username-input"
            class="w-full border border-gray-300 rounded px-3 py-1.5 text-sm"
            disabled
          />
          <button
            id="edit-username"
            class="text-gray-500 hover:text-blue-600 text-sm">锔</button
          >
          <button
            id="save-username"
            class="bg-blue-600 text-white rounded px-3 py-1.5 text-sm hidden"
          >
            Guardar
          </button>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-600 mb-1">Email</label
        >
        <input
          id="email-input"
          class="w-full border border-gray-200 rounded px-3 py-1.5 text-sm bg-gray-100"
          disabled
        />
      </div>
    </section>

    <!--  Suscripci贸n -->
    <section
      id="suscripcion-section"
      class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm space-y-4"
      style="display: none;"
    >
      <h2 class="text-lg font-medium text-gray-800">Suscripci贸n</h2>
      <p id="suscripcion-mensaje" class="text-sm text-gray-700">
        Plan: <strong id="suscripcion-plan" class="text-green-700"></strong><br
        />
        V谩lida hasta: <span id="suscripcion-fecha" class="font-medium"></span>
      </p>
      <button
        id="abrir-gestionar-modal"
        class="text-sm text-blue-600 hover:underline mt-2"
      >
        Gestionar suscripci贸n
      </button>
    </section>

    <!--  Resumen -->
    <section
      id="resumen-section"
      class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm space-y-4"
    >
      <h2 class="text-lg font-medium text-gray-800">Resumen</h2>

      <div class="grid grid-cols-2 gap-4">
        <div class="bg-gray-100 rounded p-4 text-center">
          <p class="text-sm text-gray-600">M茅todos creados</p>
          <p id="metodos-count" class="text-xl font-semibold">0</p>
        </div>
        <div class="bg-gray-100 rounded p-4 text-center">
          <p class="text-sm text-gray-600">Partidos registrados</p>
          <p id="partidos-count" class="text-xl font-semibold">0</p>
        </div>
      </div>
    </section>

    <!--  Gr谩ficos din谩micos -->
    <section id="estadisticas-section" class="space-y-6">
      <EstadisticasUsuario client:load />
    </section>

    <!-- 锔 Opciones avanzadas -->
    <section class="text-center text-sm text-gray-500 space-y-2 mt-10">
      <a href="cambiar-contrase帽a" class="hover:text-blue-600 underline"
        >Cambiar contrase帽a</a
      ><br />
      <a href="/eliminar" class="hover:text-red-600 underline"
        >Eliminar cuenta</a
      >
    </section>
  </div>

  <!--  Toast Notification -->
  <div
    id="toast"
    class="fixed bottom-6 right-6 text-white px-4 py-2 rounded shadow-md text-sm opacity-0 transition-opacity duration-300 pointer-events-none z-50"
  >
    Username actualizado
  </div>
</div>

<!-- Modal de confirmaci贸n para eliminar cuenta -->
<div
  id="delete-modal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
>
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">驴Est谩s seguro?</h2>
    <p class="text-sm text-gray-600 mb-4">
      Esta acci贸n eliminar谩 tu cuenta permanentemente y no podr谩s recuperarla.
    </p>
    <div class="flex justify-end gap-4">
      <button
        id="cancel-delete"
        class="text-sm text-gray-600 hover:text-blue-600">Volver atr谩s</button
      >
      <button
        id="confirm-delete"
        class="text-sm bg-red-800 text-white px-4 py-1.5 rounded hover:bg-red-900"
      >
        Eliminar
      </button>
    </div>
  </div>
</div>

<!-- Modal: Gestionar suscripci贸n -->
<div
  id="modal-gestionar"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
>
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full space-y-4">
    <h2 class="text-lg font-semibold text-gray-800">Gestionar suscripci贸n</h2>
    <p class="text-sm text-gray-600">
      Puedes cancelar tu suscripci贸n o cambiar de plan. Si eliges un nuevo plan
      y a煤n tienes d铆as activos, se a帽adir谩n al total y se actualizar谩 el tipo
      de suscripci贸n.
    </p>

    <div class="flex flex-col gap-3">
      <button
        id="btn-renovar"
        class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700"
      >
        Renovar / Cambiar de plan
      </button>
      <button
        id="btn-cancelar"
        class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700"
      >
        Cancelar suscripci贸n
      </button>
    </div>

    <div class="text-right pt-2">
      <button id="cerrar-modal" class="text-sm text-gray-500 hover:underline"
        >Cerrar</button
      >
    </div>
  </div>
</div>

<!-- Modal de confirmaci贸n de cancelaci贸n -->
<div
  id="modal-cancelar-confirmacion"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
>
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full space-y-4">
    <h2 class="text-lg font-semibold text-gray-800">
      驴Seguro que quieres cancelar?
    </h2>
    <p id="cancelacion-texto" class="text-sm text-gray-700">
      Tu suscripci贸n seguir谩 activa hasta el d铆a <strong>XX/XX/XXXX</strong>.
    </p>
    <div class="flex justify-end gap-4 pt-2">
      <button
        id="cancelar-cancelacion"
        class="text-sm text-gray-600 hover:text-blue-600">Volver atr谩s</button
      >
      <button
        id="confirmar-cancelacion"
        class="text-sm bg-red-700 text-white px-4 py-1.5 rounded hover:bg-red-800"
      >
        Cancelar suscripci贸n
      </button>
    </div>
  </div>
</div>

<script type="module">
  const access = localStorage.getItem("access_token");

  const authFetch = (url, options = {}) => {
    return fetch(`http://localhost:8000${url}`, {
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${access}`,
      },
      ...options,
    });
  };

  const usernameInput = document.getElementById("username-input");
  const emailInput = document.getElementById("email-input");
  const editBtn = document.getElementById("edit-username");
  const saveBtn = document.getElementById("save-username");
  const statsMetodos = document.getElementById("metodos-count");
  const statsPartidos = document.getElementById("partidos-count");

  async function loadUser() {
    const res = await authFetch("/api/auth/me/");
    if (res.ok) {
      const data = await res.json();
      usernameInput.value = data.username;
      emailInput.value = data.email;
    } else {
      showToast("No se pudo cargar tu perfil", "error");
    }

    const statsRes = await authFetch("/api/general/stats/");
    if (statsRes.ok) {
      const stats = await statsRes.json();
      statsMetodos.textContent = stats.metodos;
      statsPartidos.textContent = stats.partidos;
    }
  }

  editBtn.addEventListener("click", () => {
    usernameInput.disabled = false;
    saveBtn.classList.remove("hidden");
  });

  saveBtn.addEventListener("click", async () => {
    const newUsername = usernameInput.value.trim();
    const currentUsername = localStorage.getItem("username");

    if (!newUsername) {
      showToast("El username no puede estar vac铆o", "warning");
      return;
    }

    if (newUsername === currentUsername) {
      showToast("El username es el mismo que el actual", "info");
      return;
    }

    const res = await authFetch("/api/auth/update-username/", {
      method: "PATCH",
      body: JSON.stringify({ username: newUsername }),
    });

    const data = await res.json();

    if (res.ok) {
      localStorage.setItem("username", newUsername);
      usernameInput.disabled = true;
      saveBtn.classList.add("hidden");
      showToast("Username actualizado", "success");

      //  Refrescar header con nuevo username
      if (typeof window.checkToken === "function") {
        window.checkToken();
      }
    } else if (data?.error) {
      showToast(data.error, "error");
    } else {
      showToast("Error al actualizar el username", "error");
    }
  });

  function showToast(message = "Acci贸n completada", type = "success") {
    const toast = document.getElementById("toast");
    if (!toast) return;

    const colorClasses = {
      success: "bg-green-600",
      error: "bg-red-600",
      info: "bg-blue-600",
      warning: "bg-yellow-500 text-black",
    };

    toast.className =
      "fixed bottom-6 right-6 text-white px-4 py-2 rounded shadow-md text-sm opacity-0 transition-opacity duration-300 pointer-events-none z-50";

    const classListToAdd = (colorClasses[type] || colorClasses.success).split(
      " "
    );
    toast.classList.add(...classListToAdd);
    toast.textContent = message;

    toast.classList.remove("opacity-0");
    toast.classList.add("opacity-100");

    setTimeout(() => {
      toast.classList.add("opacity-0");
      toast.classList.remove("opacity-100");
    }, 2500);
  }

  loadUser();
  loadSuscripcion();

  async function loadSuscripcion() {
    const res = await authFetch("/api/general/suscripcion/");
    const section = document.getElementById("suscripcion-section");
    const mensaje = document.getElementById("suscripcion-mensaje");
    const resumen = document.getElementById("resumen-section");
    const estadisticas = document.getElementById("estadisticas-section");

    section.style.display = "block";

    if (!res.ok) {
      mensaje.textContent = "No se pudo cargar tu suscripci贸n.";
      resumen.innerHTML =
        "<p class='text-sm text-gray-500 text-center'>Contrata un plan para ver tu resumen.</p>";
      estadisticas.innerHTML =
        "<p class='text-sm text-gray-500 text-center'>Contrata un plan para ver tus estad铆sticas.</p>";
      return;
    }

    const data = await res.json();
    if (!data || !data.activa) {
      mensaje.textContent = "No tienes ninguna suscripci贸n activa.";
      resumen.innerHTML =
        "<p class='text-sm text-gray-500 text-center'>Contrata un plan para ver tu resumen.</p>";
      estadisticas.innerHTML =
        "<p class='text-sm text-gray-500 text-center'>Contrata un plan para ver tus estad铆sticas.</p>";
      return;
    }

    // Si hay suscripci贸n activa, mostramos los datos correctamente
    mensaje.innerHTML = `Plan: <strong class="text-green-700">${data.plan}</strong><br/>V谩lida hasta: <span class="font-medium">${new Date(data.fecha_fin).toLocaleDateString()}</span>`;
  }

  // Eliminar cuenta con confirmaci贸n
  const deleteLink = document.querySelector('a[href="/eliminar"]');
  const modal = document.getElementById("delete-modal");
  const cancelBtn = document.getElementById("cancel-delete");
  const confirmBtn = document.getElementById("confirm-delete");

  deleteLink.addEventListener("click", (e) => {
    e.preventDefault();
    modal.classList.remove("hidden");
  });

  cancelBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  confirmBtn.addEventListener("click", async () => {
    const res = await authFetch("/api/auth/delete-user/", {
      method: "DELETE",
    });

    if (res.ok) {
      localStorage.clear();
      showToast("Cuenta eliminada", "success");
      setTimeout(() => {
        window.location.href = "/";
      }, 1500);
    } else {
      showToast("Error al eliminar cuenta", "error");
      modal.classList.add("hidden");
    }
  });

  // Modal gestionar suscripci贸n
  const gestionarModal = document.getElementById("modal-gestionar");
  const abrirModalBtn = document.getElementById("abrir-gestionar-modal");
  const cerrarModalBtn = document.getElementById("cerrar-modal");
  const cancelarBtn = document.getElementById("btn-cancelar");
  const renovarBtn = document.getElementById("btn-renovar");

  abrirModalBtn?.addEventListener("click", () => {
    gestionarModal.classList.remove("hidden");
  });
  cerrarModalBtn?.addEventListener("click", () => {
    gestionarModal.classList.add("hidden");
  });

  // Cancelar suscripci贸n
  // Mostrar modal de confirmaci贸n con la fecha real
  let fechaFinSuscripcion = null;

  cancelarBtn?.addEventListener("click", async () => {
    const res = await authFetch("/api/general/suscripcion/");
    if (!res.ok) {
      showToast("Error al obtener la fecha de tu suscripci贸n", "error");
      return;
    }

    const data = await res.json();
    fechaFinSuscripcion = new Date(data.fecha_fin).toLocaleDateString();

    const texto = document.getElementById("cancelacion-texto");
    texto.innerHTML = `Tu suscripci贸n seguir谩 activa hasta el d铆a <strong>${fechaFinSuscripcion}</strong>. 驴Quieres cancelarla?`;

    document
      .getElementById("modal-cancelar-confirmacion")
      .classList.remove("hidden");
  });

// Confirmar cancelaci贸n real
document
  .getElementById("confirmar-cancelacion")
  ?.addEventListener("click", async () => {
    const res = await authFetch("/api/general/suscripcion/", {
      method: "PATCH",
      body: JSON.stringify({ cancelar: true }),
    });

    if (res.ok) {
      const data = await res.json();
      const fechaFin = new Date(data.fecha_fin).toLocaleDateString();

      showToast(
        `Tu suscripci贸n ha sido cancelada. Seguir谩 activa hasta el ${fechaFin}.`,
        "info"
      );

      document
        .getElementById("modal-cancelar-confirmacion")
        .classList.add("hidden");
      gestionarModal.classList.add("hidden");

      setTimeout(() => window.location.reload(), 3000);
    } else {
      showToast("Error al cancelar suscripci贸n", "error");
    }
  });


  // Cerrar modal de confirmaci贸n
  document
    .getElementById("cancelar-cancelacion")
    ?.addEventListener("click", () => {
      document
        .getElementById("modal-cancelar-confirmacion")
        .classList.add("hidden");
    });

  // Renovar / cambiar plan
  renovarBtn?.addEventListener("click", () => {
    gestionarModal.classList.add("hidden");
    window.location.href = "/planes";
  });
</script>
